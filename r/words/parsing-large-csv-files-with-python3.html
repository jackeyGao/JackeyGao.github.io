<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="author"  content="JackeyGao">
    <meta name="description" content="JackeyGao, ä¸€ä¸ªç¨‹åºå‘˜çš„æŠ€æœ¯åˆ†äº«å’Œå¯¹ç”Ÿæ´»çš„ç†è§£.">
    <meta name="keywords"  content="JackeyGao, JackeyGaoçš„æ—¥è®°æœ¬, Python, Django, Vue.js, chinese-poetry">
    <title>ç”¨æˆ·Python3è§£æè¶…å¤§çš„csvæ–‡ä»¶</title>
    <meta name="google-site-verification" content="xTBu05X0P9OJkoWvQWGdZimRp6nD6uqesWwTJ6v-BoA" />
    <meta name="google-site-verification" content="7Obwo8u7tT_NKgyJiirEB1qRpINEnh9BtyBa1WtiVjU" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon/favicon-16x16.png">
    <link rel="manifest" href="/static/favicon/site.webmanifest">
    <link rel="mask-icon" href="/static/favicon/safari-pinned-tab.svg" color="#286272">
    <link rel="shortcut icon" href="/static/favicon/favicon.ico">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="/static/favicon/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <link rel="stylesheet" href="/static/global.css">
    <link rel="stylesheet" href="/static/mobile.css">
    

    
<link rel="stylesheet" href="/static/word.css">
<link rel="stylesheet" href="/static/highlight.css">
<link rel="stylesheet" href="/static/3rd/gitalk.css">

<style>
</style>

  </head>

  <body>
    <div id="canvasWrapper">
      <div id="canvas">
        <div id="toTop" onclick="topFunction();">â‡ª</div>

        <div id="mobileNav" class="hidden">
          <div id="avatarWrapper">
            <img class="avatar" src="/static/images/avatar.png">
          </div>
          <div id="menuNav"></div>
        </div>
        <div id="headerWrapper">
            <header>
                <div id="topNavMobile">
                    <nav id="mobileMenuLink" onclick="ToggleMenu()" class="main-nav clear">â˜°</nav>
                  </div>
                <div id="logo">
                  <a href='/'><img class="logo image" src="/static/images/logo.png"></a>
                </div>
                <div id="topNav">
                  <nav id="mainNavigation">
                    <ul>
                      <li>
                        <a href="/">æ–‡ç« </a>
                      </li>
                      <li>
                        <a href="/r/about.html">å…³äº</a>
                      </li>
                      <li>
                        <a href="/r/links.html">é“¾æ¥</a>
                      </li>
                      <li>
                        <a href="#">áƒ¦</a>
                      </li>
                    </ul>
                  </nav>
                  <nav id="secondaryNavigation">
                    <ul>
                      
                      <li>
                        <a href="/r/sets.html#çJBæ‰¯æ·¡">çJBæ‰¯æ·¡</a>
                      </li>
                      
                      <li>
                        <a href="/r/sets.html#éšç¬”">éšç¬”</a>
                      </li>
                      
                      <li>
                        <a href="/r/sets.html#æ·«è¯—ä½œå¯¹">æ·«è¯—ä½œå¯¹</a>
                      </li>
                      
                      <li>
                        <a href="/r/sets.html#ä¸ªäººé¡¹ç›®">ä¸ªäººé¡¹ç›®</a>
                      </li>
                      
                      <li>
                        <a href="/r/sets.html#å¥½ç©çš„Django">å¥½ç©çš„Django</a>
                      </li>
                      
                      <li>
                        <a href="/r/sets.html#Djangoå°æŠ€å·§">Djangoå°æŠ€å·§</a>
                      </li>
                      
                    </ul>
                  </nav>
                </div>

                <div id="avatarWrapper">
                  <img class="avatar" src="/static/images/avatar.png">
                </div>
            </header>
          </div>
        <div id="pageWrapper">
          
<div id="content" class="typo ui container">
    <div id="article">
        <h1 class="bigtitle">ç”¨æˆ·Python3è§£æè¶…å¤§çš„csvæ–‡ä»¶</h1>
        <p class="post-date">Posted August 15, 2016</p>
        <p>æˆ‘åœ¨æ—¥å‰è·å¾—ä¸€ä¸ªä»»åŠ¡ï¼Œä¸ºäº†åšåˆ†æ, ä»ä¸€ä¸ªè¶…å¤§çš„csvæ–‡ä»¶ä¸­è§£æemailåœ°å€å’Œå¯¹åº”çš„æ—¥æœŸæ—¶é—´æˆ³ç„¶åæ’å…¥åˆ°æ•°æ®åº“ä¸­. æˆ‘çŸ¥é“æœ‰å…¶ä»–å·¥å…·å¯ä»¥æ–¹ä¾¿çš„å®Œæˆæˆ‘çš„å·¥ä½œ(æ¯”å¦‚pandas),å¯¹äºæœ¬æ–‡çš„ç›®çš„, æˆ‘åªæ‰“ç®—ç”¨pythonçš„æ–¹å¼æ¥å¤„ç†è¿™äº›æ•°æ®.</p>

<p>è¿™ä¸ªcsvæ–‡ä»¶è¶…è¿‡äº†2G, 200ä¸‡æ¡çš„æ•°æ®. èµ·åˆ, æˆ‘å°è¯•ç”¨excelæ‰“å¼€è¿™ä¸ªæ–‡ä»¶ï¼Œ æ¥æŸ¥çœ‹æ•°æ® ã€‚ä¸å¹¸çš„æ˜¯, æˆ‘çš„excelç¨‹åºå¼€å§‹å‡æ­»æœ€åæˆ‘ä¸å¾—ä¸æ€æ‰excelè¿›ç¨‹.</p>
<h2 id="ä½¿ç”¨Generators">ä½¿ç”¨Generators</h2><blockquote class="blockquote-normal">
                <p>A generator function is mainly a more convenient way of writing an iterator. You donâ€™t have to worry about the iterator protocol (.next, .<strong>iter</strong>, etc.). It just works.â€Šâ€”â€ŠDavid Beazley, <a href="http://www.dabeaz.com/generators/">Generator Tricks for Systems Programmers</a></p></blockquote>
<p>Generators å¯ä»¥è®©ä½ å¾ˆå®¹æ˜“çš„ä»ä¸€ä¸ªå¾ˆå¤§çš„æ•°æ®é›†æƒ°æ€§éå†è·å–å•æ¡æ•°æ®, è€Œä¸æ˜¯å…¨éƒ¨è¯»å…¥å†…å­˜.</p>
<figure id="code-6289264342914654053" class="code-wrapper"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_email_data</span><span class="p">(</span><span class="n">csv_fname</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_fname</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;latin-1&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">email_records</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">email_record</span> <span class="ow">in</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">email_records</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">email_record</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;./emailData.csv&quot;</span>
    <span class="n">iter_email</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">get_email_data</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
    <span class="nb">next</span><span class="p">(</span><span class="n">iter_email</span><span class="p">)</span>  <span class="c1"># Skipping the column names</span>

    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">iter_email</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</pre></div>
<figcaption><a class="lang-label" href="#code-6289264342914654053"><\>Python</a></figcaption></figure>
<p>ä½†è¿™æ ·æŠ¥äº†ä¸€ä¸ªé”™...</p>
<figure id="code-7500343944996728158" class="code-wrapper"><div class="highlight"><pre><span></span><span class="ne">UnicodeDecodeError</span><span class="p">:</span> <span class="s1">&#39;ascii&#39;</span> <span class="n">codec</span> <span class="n">can</span><span class="s1">&#39;t decode byte 0xe8 in position 1: ordinal not in range(128).</span>
</pre></div>
<figcaption><a class="lang-label" href="#code-7500343944996728158"><\>Python</a></figcaption></figure><h2 id="å…³äºUnicode">å…³äºUnicode</h2><blockquote class="blockquote-normal">
                <p>The best practice for handling text is the â€œUnicode sandwichâ€ . This means that bytes should be decoded to str as early as possible on input (e.g., when opening a file for reading). The â€œmeatâ€ of the sandwich is the business logic of your program, where text handling is done exclusively on str objects. You should never be encoding or decoding in the middle of other processing. On output, the str are encoded to bytes as late as possible.â€Šâ€”â€ŠLuciano Ramalho, Fluent Python</p></blockquote>
<p>å› ä¸ºæˆ‘è°ƒè¯•çš„æ—¶å€™æ‰“å°åœ¨windowsç»ˆç«¯ä¸Š, å› ä¸ºwindowsé»˜è®¤ä¸æ”¯æŒunicode, æ‰€ä»¥å‡ºç°äº†æ­¤é”™è¯¯. ç„¶åæˆ‘ä¿®æ”¹äº†<code>get_email_data</code></p>
<figure id="code-8186067304151850792" class="code-wrapper"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_email_data</span><span class="p">():</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_fname</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;latin-1&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">email_records</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">email_record</span> <span class="ow">in</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">email_records</span><span class="p">):</span>
            <span class="n">ascii_record</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> 
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">email_record</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">ascii_record</span>
</pre></div>
<figcaption><a class="lang-label" href="#code-8186067304151850792"><\>Python</a></figcaption></figure>
<p>æ³¨æ„: <code>erros=&#39;replace&#39;</code> å‚æ•°, è¯¥æ–¹æ¡ˆä¸èƒ½å®Œç¾çš„è§£å†³é—®é¢˜, å½“ç¼–ç ä¸€ä¸ªå­—ç¬¦ä¸²å‡ºç°é—®é¢˜, Python æä¾›äº†ä¸‰ç§æ–¹æ³•:</p>

<ul>
<li>1. strict - æŠ›å‡ºä¸€ä¸ªè‡´å‘½çš„é”™è¯¯</li>
<li>2. ignore - åˆ é™¤è¿™ä¸ªå­—ç¬¦</li>
<li>3. replace - ç”¨?æ›¿æ¢å­—ç¬¦</li>
</ul>

<p>replace è™½ç„¶ä¸ç†æƒ³, ä½†ä»–é€‚åˆæˆ‘çš„éœ€è¦. ä½¿ç”¨å®ƒèƒ½è®©æˆ‘çš„ç¨‹åºå®Œæ•´çš„è·‘è¿‡å», è€Œæ²¡æœ‰unicodeé”™è¯¯. </p>
<h2 id="æ›´é”¦ä¸Šæ·»èŠ±">æ›´é”¦ä¸Šæ·»èŠ±</h2>
<p>æˆ‘ä¸å¤ªæƒ³ç”¨ç´¢å¼•æ¥è·å–æ•°æ®, å°±åƒä¸‹é¢ä¸€æ ·ï¼Œ ä¸€ç‚¹éƒ½ä¸pythonic</p>
<figure id="code5453296075636257045" class="code-wrapper"><div class="highlight"><pre><span></span><span class="c1"># Example: email_row[0], email_row[1], email_row[2], etc...</span>
</pre></div>
<figcaption><a class="lang-label" href="#code5453296075636257045"><\>Python</a></figcaption></figure>
<p>å½“ç„¶è¿™æ ·æ‰æ˜¯æ›´äººæ€§åŒ–ï¼Œ æˆ‘ä¹Ÿå°†è¦ä¼˜åŒ–æˆè¿™æ ·</p>
<figure id="code-6576262431221046493" class="code-wrapper"><div class="highlight"><pre><span></span><span class="c1"># Example: email_row.date, email_row.from, email_row.to, etc...</span>
</pre></div>
<figcaption><a class="lang-label" href="#code-6576262431221046493"><\>Python</a></figcaption></figure>
<p><code>NamedTuples</code> æ­£åˆæˆ‘æ„, è¿™é‡ŒåŒæ ·ä¿®æ”¹<code>get_email_data</code>å‡½æ•° </p>
<figure id="code2854063761867811989" class="code-wrapper"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_email_data</span><span class="p">(</span><span class="n">csv_fname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A generator for the data in the csv. This is because the csv files can often contain millions of records and shouldn&#39;t be stored in memory all at once.</span>

<span class="sd">    :param csv_fname:</span>
<span class="sd">        filename/location of the csv.</span>

<span class="sd">    :return:</span>
<span class="sd">        yields each row as a namedtuple.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">EmailRecord</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;EmailRecord&#39;</span><span class="p">,</span> <span class="s1">&#39;date size from_addr  to_addr subject excerpt&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_fname</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;latin-1&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">email_records</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">email_record</span> <span class="ow">in</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">email_records</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">email_record</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span> <span class="c1"># a valid row</span>
                <span class="n">ascii_email_record</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">email_record</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">EmailRecord</span><span class="p">(</span><span class="o">*</span><span class="n">ascii_email_record</span><span class="p">)</span>
</pre></div>
<figcaption><a class="lang-label" href="#code2854063761867811989"><\>Python</a></figcaption></figure>
<p>å…³äºNamedTuplesï¼Œ å®ƒå±äºæ ‡å‡†åº“é‡Œé¢çš„, å¯ä»¥è®¿é—®è¿™é‡ŒæŸ¥çœ‹æ–‡æ¡£ <a href="https://docs.python.org/3/library/collections.html#collections.namedtuple">NamedTuples</a></p>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>æˆ‘ä»¬åªæ˜¯å­¦ä¹ æ€ä¹ˆè®©è‡ªå·±çš„ç”µè„‘ä¸æ­»æœº, ç„¶åå‹å¥½çš„å¤„ç†å¤§çš„æ–‡ä»¶. åŒæ—¶æˆ‘ä»¬è¿˜å­¦ä¹ äº†æ›´åŠ å¤šçš„å®ç”¨çš„æŠ€å·§:</p>

<ul>
<li>Generators</li>
<li>å­—ç¬¦ç¼–ç é—®é¢˜</li>
<li>NamedTuples</li>
</ul>

        
    </div>

    <hr>
    
    <div class="controls">
      <div class="trigger-comment" onclick=" gitalk.render('comments');">ğ””</div>
      
    </div>

    <div id="comments"></div>
</div>

        </div>
        <div id="footerWrapper">
        </div>
      </div>
    </div>
  </body>
  <script>
  window.menu = 'â˜°'
  function ToggleMenu () {
    var mobile = document.getElementById('mobileNav');
    var menu = document.getElementById('menuNav');
    var t = document.getElementById('mobileMenuLink');
    var topNav = document.getElementById('topNav');
  
    if (mobile.className === "visible") {
      mobile.className = 'hidden'
      t.innerHTML = 'â˜°'
      window.menu = 'â˜°'
    } else {
      mobile.className = 'visible'
      menu.innerHTML = topNav.innerHTML;
      t.innerHTML = 'âŒ«'
      window.menu = 'âŒ«'
    }
  }

  window.onscroll = function() {scrollFunction()};

  function topFunction() {
    document.body.scrollTop = 0;
    document.documentElement.scrollTop = 0;
  }

  function scrollFunction() {
    var t = document.getElementById('mobileMenuLink');
    var toTop = document.getElementById('toTop');
    var m = document.getElementById('mobileNav');
    var scrollTop = m.offsetHeight > 100 ? m.offsetHeight : 800;
    if (document.body.scrollTop > scrollTop || document.documentElement.scrollTop > scrollTop) {
      t.innerHTML = 'â‡ª'
      t.onclick = function() {topFunction()};
      toTop.className = 'visible'
    } else {
      t.innerHTML = window.menu
      t.onclick = function() {ToggleMenu()};
      toTop.className = ''
    }
  }

  </script>

  

  
<script src="/static/3rd/gitalk.min.js"></script>
<script>
  const gitalk = new Gitalk({
      clientID: '177af99888a292531873',
      clientSecret: '7c0927c7cdf0d94eed7dad0b238552c10ec6f53c',
      repo: 'JackeyGao.github.io',
      owner: 'jackeyGao',
      admin: ['jackeyGao'],
      id: 'parsing-large-csv-files-with-python3',      // Ensure uniqueness and length less than 50
      distractionFreeMode: false,  // Facebook-like distraction free mode
      labels: ['gitment'],
      pagerDirection: "last"
  })
  // gitalk.render('comments')
</script>

</html>
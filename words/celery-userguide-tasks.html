<html>
    <head>
        <meta charset="utf-8">
        
    
        <meta name="author"  content="JackeyGao">
        <meta name="description" content="JackeyGao, ä¸€ä¸ªç¨‹åºå‘˜çš„æŠ€æœ¯åˆ†äº«å’Œå¯¹ç”Ÿæ´»çš„ç†è§£.">
        <meta name="keywords"  content="JackeyGao, JackeyGaoçš„æ—¥è®°æœ¬, Python, Django, Vue.js, chinese-poetry">
        <title> Celeryç”¨æˆ·æ‰‹å†Œ - Tasks </title>
        <meta name="google-site-verification" content="xTBu05X0P9OJkoWvQWGdZimRp6nD6uqesWwTJ6v-BoA" />
        <meta name="google-site-verification" content="7Obwo8u7tT_NKgyJiirEB1qRpINEnh9BtyBa1WtiVjU" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="/assets/global.css">
        <link rel="stylesheet" href="/assets/theme.css">
        <link rel="stylesheet" href="/assets/semantic/components/button.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/site.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/icon.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/card.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/grid.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/feed.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/list.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/container.min.css">
        <link rel="stylesheet" href="/assets/semantic/components/input.min.css">
        <link rel="shortcut icon" href="/assets/images/favicon.ico" type="image/x-icon">
        <link rel="apple-touch-icon" sizes="128x128" href="/assets/images/favicon.ico">
        <link rel="icon" href="/assets/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="/assets/words.css">
    <link rel="stylesheet" href="/assets/monokai.css">
    <link rel="stylesheet" href="/assets/3rd/gitalk.css">
    <link rel="stylesheet" href="/assets/semantic/components/table.min.css">

    </head>
    
    <body class="sk-default">
        <div id="site-wrapper" style="display: none;" class="topwrapper">
            <div class="ui container">
                <h3><span style="color: var(--main-bgc);">ä¸»é¢˜é€‰æ‹©</span></h3>

                <div id="theme">
                    <div onclick="document.body.className = 'sk-default'; localStorage.setItem('skin', 'sk-default');" class="sk-default skin">é’</div>
                    <div onclick="document.body.className = 'sk-mo'; localStorage.setItem('skin', 'sk-mo');" class="sk-mo skin">å¢¨</div>
                    <div onclick="document.body.className = 'sk-green'; localStorage.setItem('skin', 'sk-green');" class="sk-green skin">ç»¿</div>
                    <div onclick="document.body.className = 'sk-orange'; localStorage.setItem('skin', 'sk-orange');" class="sk-orange skin">æ©˜</div>
                    <div onclick="document.body.className = 'sk-yellow'; localStorage.setItem('skin', 'sk-yellow');" class="sk-yellow skin">é»„</div>
                    <div onclick="document.body.className = 'sk-pink'; localStorage.setItem('skin', 'sk-pink');" class="sk-pink skin">ç²‰</div>
                </div>
                <!--
                <table id="theme" style="width: 100%; color: #fff; margin-left: auto; margin-right: auto;">
                        <tbody>
                            <tr onclick="document.body.className = 'sk-mo'; localStorage.setItem('skin', 'sk-mo');">
                                <td class="title">å¢¨</td>
                                <td width="50%;" class="sk-mo"><div style="width: 100%;height: 25px; background: var(
                            </tr>
                            <tr onclick="document.body.className = 'sk-green'; localStorage.setItem('skin', 'sk-green');">
                                <td class="title">ç»¿</td>
                                <td width="50%;" class="sk-green"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg"></div></td>
                            </tr>
                            <tr onclick="document.body.className = 'sk-default'; localStorage.setItem('skin', 'sk-default');">
                                <td class="title">é’</td>
                                <td width="50%;" class="sk-default"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg"></div></td>
                            </tr>
                            <tr onclick="document.body.className = 'sk-orange'; localStorage.setItem('skin', 'sk-orange');">
                                <td class="title">æ©˜</td>
                                <td width="50%;" class="sk-orange"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg ">
                                </div></td>
                            </tr>
                            <tr onclick="document.body.className = 'sk-yellow'; localStorage.setItem('skin', 'sk-yellow');">
                                <td class="title">å§œ</td>
                                <td width="50%;" class="sk-yellow"><div style="width: 100%;height: 25px; background: var(--main-bg);" class="bg ">
                                </div></td>
                            </tr>
                        </tbody>
                    </table>
                -->
            </div>
        </div>
        <div id="cats-wrapper" style="display: none;" class="topwrapper">
            <div class="ui container">
                <table style="color: #fff;">
                    <tbody>
                        <tr>
                            <td valign="middle" align="center" width="50%">
                                <img src="/assets/cat-bn-avatar.jpeg" />
                                <div class="name">æ³¢å¦</div>
                                <div class="time">2017å¹´2æœˆ21å·</div>
                            </td>
                            <td valign="middle" align="center" width="50%">
                                <img src="/assets/cat-ss-avatar.png" />
                                <div class="name">ä¸‰ä¸‰</div>
                                <div class="time">2017å¹´4æœˆ10å·</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
        </div>
        <div id="donation-wrapper" style="display: none;" class="topwrapper">
            <div class="ui container" style="text-align: center;">
                <div class="description">
                    <i class="teal quote left icon"></i>
                    å¦‚æœè§‰å¾—æˆ‘çš„æ–‡ç« å¯¹æ‚¨æœ‰ç”¨ï¼Œè¯·éšæ„æ‰“èµã€‚æ‚¨çš„æ”¯æŒå°†é¼“åŠ±æˆ‘ç»§ç»­åˆ›ä½œ!
                    <i class="teal quote right icon"></i>
                </div>

                <div class="ui buttons">
                    <button onclick="useWechat()" id="wechat" class="ui active secondary icon button">
                        å¾®ä¿¡
                    </button>
                    <button onclick="useAlipay()" id="alipay" class="ui secondary icon button">
                        æ”¯ä»˜å®
                    </button>
                </div>

                <div id="donation-qrcode">
                    <img id="wechat-qrcode-image" src="/assets/images/wechat.png">
                    <img id="alipay-qrcode-image" src="/assets/images/alipay.jpg">
                    <!-- <img id="donation-qrcode-image" src="/assets/images/wechat.png"> -->
                </div>
            </div>
        </div>
        <div id="friends-links-wrapper" style="display: none;" class="topwrapper">
            <div class="ui container" style="text-align: center; padding-top: 2em; padding-bottom: 2em;">
                <div class="ui stackable two column grid">
                    
                    <div class="column" style="padding-left: 0; padding-right: 0;">
                        <div class="ui feed" href="https://jackeygao.io" style="padding: .5em 1em;">
                            <div class="event">
                              <div class="label">
                                <img src="/assets/images/avatar.png">
                              </div>
                              <div class="content">
                                <div class="date">
                                   JackeyGao
                                </div>
                                <a href="https://jackeygao.io" class="summary">
                                   JackeyGaoç¬”è®°æœ¬
                                </a>
                              </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="column" style="padding-left: 0; padding-right: 0;">
                        <div class="ui feed" href="https://www.yangshiwei.top" style="padding: .5em 1em;">
                            <div class="event">
                              <div class="label">
                                <img src="/uploads/images/friends/yangshiwei.jpg">
                              </div>
                              <div class="content">
                                <div class="date">
                                   Yangshiwei
                                </div>
                                <a href="https://www.yangshiwei.top" class="summary">
                                   æ¨ä¸–å¨ä¸ªäººç«™
                                </a>
                              </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="column" style="padding-left: 0; padding-right: 0;">
                        <div class="ui feed" href="https://weijunzii.github.io" style="padding: .5em 1em;">
                            <div class="event">
                              <div class="label">
                                <img src="/uploads/images/friends/weijunzi.png">
                              </div>
                              <div class="content">
                                <div class="date">
                                   ä¼ªå›å­
                                </div>
                                <a href="https://weijunzii.github.io" class="summary">
                                   ä¼ªå›å­çš„æ¢¦å‘“
                                </a>
                              </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="column" style="padding-left: 0; padding-right: 0;">
                        <div class="ui feed" href="https://blog.willdx.me" style="padding: .5em 1em;">
                            <div class="event">
                              <div class="label">
                                <img src="/uploads/images/friends/willdx.png">
                              </div>
                              <div class="content">
                                <div class="date">
                                   willdx
                                </div>
                                <a href="https://blog.willdx.me" class="summary">
                                   Will Dxçš„åšå®¢
                                </a>
                              </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="column" style="padding-left: 0; padding-right: 0;">
                        <div class="ui feed" href="http://rw.imdancer.com/" style="padding: .5em 1em;">
                            <div class="event">
                              <div class="label">
                                <img src="/uploads/images/friends/willdx.png">
                              </div>
                              <div class="content">
                                <div class="date">
                                   willdx
                                </div>
                                <a href="http://rw.imdancer.com/" class="summary">
                                   è¯»Â·å†™
                                </a>
                              </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="column" style="padding-left: 0; padding-right: 0;">
                        <div class="ui feed" href="http://liangyouqiao.me/" style="padding: .5em 1em;">
                            <div class="event">
                              <div class="label">
                                <img src="/uploads/images/friends/joe.jpg">
                              </div>
                              <div class="content">
                                <div class="date">
                                   Joe.
                                </div>
                                <a href="http://liangyouqiao.me/" class="summary">
                                   LY.Qiao
                                </a>
                              </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="column" style="padding-left: 0; padding-right: 0;">
                        <div class="ui feed" href="http://www.yuchen.info" style="padding: .5em 1em;">
                            <div class="event">
                              <div class="label">
                                <img src="/uploads/images/friends/yuchen.png">
                              </div>
                              <div class="content">
                                <div class="date">
                                   Yu Chen
                                </div>
                                <a href="http://www.yuchen.info" class="summary">
                                   â¹çµ†
                                </a>
                              </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="column" style="padding-left: 0; padding-right: 0;">
                        <div class="ui feed" href="http://lovefc.cn" style="padding: .5em 1em;">
                            <div class="event">
                              <div class="label">
                                <img src="/uploads/images/friends/lovefc.jpg">
                              </div>
                              <div class="content">
                                <div class="date">
                                   lovefc
                                </div>
                                <a href="http://lovefc.cn" class="summary">
                                   å°å°˜åšå®¢
                                </a>
                              </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="column" style="padding-left: 0; padding-right: 0;">
                        <div class="ui feed" href="https://sunyancn.github.io/" style="padding: .5em 1em;">
                            <div class="event">
                              <div class="label">
                                <img src="/uploads/images/friends/sunyan.png">
                              </div>
                              <div class="content">
                                <div class="date">
                                   sunyan
                                </div>
                                <a href="https://sunyancn.github.io/" class="summary">
                                   Sun Yan's Blog
                                </a>
                              </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
                <div class="about-friendly-link">
                    <a href="/words/links.html">
                        <i class="question circle outline icon"></i>æˆ‘ä¹Ÿè¦å‡ºç°åœ¨è¿™é‡Œ.
                    </a>
                </div>
            </div>
        </div>

        <div id="social-links-wrapper" style="display: none;" class="topwrapper">
            <a href="mailto:gaojunqi@outlook.com">
                <button class="ui mini red circular icon button">
                    <i class="mail icon"></i>
                </button>
            </a>
            <a href="https://github.com/jackeygao">
                <button class="ui mini grey circular github icon button">
                  <i class="github icon"></i>
                </button>
            </a>
            <a href="https://twitter.com/JackeyGaoo">
                <button class="ui mini circular twitter icon button">
                  <i class="twitter icon"></i>
                </button>
            </a>
            <button onclick="toggleWechat()" class="ui mini green circular icon button">
                <i class="wechat icon"></i>
            </button>
            
            <div id="wx" style="display: none;">
                <img src="/assets/images/wx.jpeg" />
            </div>
        </div>

        <div id="search-wrapper" style="display: none;" class="topwrapper">
            <div id="search" class="ui container">
                <input id="searchInput" onkeypress="return search(event)" type="search" placeholder="Search with google...">
            </div>
        </div>

        <div id="topbar"></div>

        <div id="triggers-wrapper">
            <div class="ui black mini buttons">
                <button onclick="toggleById(wrappers, 'site-wrapper')" class="ui secondary site-wrapper icon button">
                    <i class="snowflake icon"></i>
                </button>
    
                <button onclick="toggleById(wrappers, 'social-links-wrapper')" class="ui secondary social-links-wrapper icon button">
                    <i class="sign language icon"></i>
                </button>
                <button onclick="toggleById(wrappers, 'friends-links-wrapper')" class="ui secondary friends-links-wrapper icon button">
                    <i class="users icon"></i>
                </button>
                <button onclick="toggleById(wrappers, 'search-wrapper')" class="ui secondary search-wrapper icon button">
                    <i class="search icon"></i>
                </button>
                <!--
                <button onclick="toggleById(wrappers, 'cats-wrapper')" class="ui secondary cats-wrapper icon button">
                    ğŸ±
                </button>
                -->
                <button onclick="toggleById(wrappers, 'donation-wrapper')" class="ui secondary donation-wrapper icon button">
                    <i class="gift icon"></i>
                </button>
            </div>
        </div> 
    
        <div id="main">
            <div class="me">
                <div class="avatar">
                    <img src="/assets/images/avatar.png">
                </div>
    
                <div class="name">
                    <img width="150px" src="/assets/images/jackeygao.png"/>
                </div>

                <span class="sign">äººä¸–ä¸€èº«éœœé›ª, å½’æ¥ä»æ˜¯å°‘å¹´.</span>
            </div>
            
            <div class="top menu">
                <div class="ui horizontal bulleted link list">
                    <a href="/" class="item">
                        ä¸»é¡µ
                    </a>
                    <a href="/sets.html" class="item">
                        ä¸“é¢˜
                    </a>
                    <a href="/about.html" class="item">
                        å…³äºæˆ‘
                    </a>
                    <a href="#social-links-wrapper" style="cursor: pointer;" class="item" onclick="toggleById(wrappers, 'social-links-wrapper')">
                        è”ç³»
                    </a>
                    <a href="/rss.xml" class="item">
                        RSS 
                    </a>
                </div>
            </div>

            
<div id="content" class="typo ui container">
    <div id="article">
        <h1 class="bigtitle">Celeryç”¨æˆ·æ‰‹å†Œ - Tasks</h1>
        <p class="post-date">Posted April 19, 2016</p>
        <p><code>Tasks</code>æ˜¯Celery åº”ç”¨çš„æ„å»ºå—ã€‚äº‹å®ä¸ŠCeleryåº”ç”¨æ˜¯ç”±ä¸€ä¸ªæˆ–å¤šä¸ªTaskæ‹¼è£…ç»„æˆçš„ã€‚</p>

<p>ä¸€ä¸ªTaskå³æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œ Taskè¢«åˆ›å»ºåå¯ä»¥è¢«æ‰€æœ‰è°ƒç”¨ï¼Œ å®ƒæ˜¯åŒé‡è§’è‰²ï¼Œ å½“Taskè¢«è°ƒç”¨å¯ä»¥é€šè¿‡Taskå¯ä»¥å‘é€æ¶ˆæ¯ï¼Œ åŒæ—¶å½“ä½œä¸ºä¸€ä¸ªworkerçš„æ—¶å€™å¯ä»¥æ¥æ”¶æ¶ˆæ¯ï¼Œå¹¶æ¶ˆè´¹ã€‚</p>

<p>æ¯ä¸ªTask name éƒ½æ˜¯å”¯ä¸€çš„ï¼Œ è¿™æ ·å¯ä»¥é€šè¿‡è¿™ä¸ªåå­—ï¼Œæ‰¾åˆ°åˆé€‚çš„functionå»æ‰§è¡Œæ¶ˆè´¹ã€‚</p>

<p>å½“å‘é€ä¸€ä¸ªä»»åŠ¡æ¶ˆæ¯åœ¨workerç¡®è®¤(acknowledged)å‰ä¸ä¼šæ¶ˆå¤±ï¼Œä¸€ä¸ªworkerå¯ä»¥æå‰å­˜å‚¨å¾ˆå¤šæ¶ˆæ¯ï¼Œå¦‚æœworkerè¿›ç¨‹å´©æºƒæˆ–killedï¼Œæ¶ˆæ¯ä¹Ÿä¸ä¼šæ¶ˆå¤±ï¼Œ æ¶ˆæ¯ä¼šé€šè¿‡åœ¨æŠ•é€’çš„æ–¹å¼ç»™å…¶ä»–å­˜æ´»workerã€‚</p>

<p>ç†æƒ³çš„Taskå‡½æ•°å¿…é¡»æ˜¯å¹‚ç­‰çš„ï¼Œè¿™æ„å‘³ç€ç›¸åŒçš„å‚æ•°è°ƒç”¨å¤šæ¬¡ä¸ä¼šå‡ºç°ä¸åŒçš„ç»“æœã€‚ä½†æ˜¯workerå¹¶ä¸çŸ¥é“å‡½æ•°æ˜¯å¹‚ç­‰çš„ï¼Œ wokeré»˜è®¤æ˜¯æå‰ç¡®è®¤æ¶ˆæ¯ï¼Œ åœ¨æ‰§è¡Œå®Œæˆä¹‹å‰è¿™ä¸ªtaskæ°¸è¿œä¸ä¼šè¢«é‡å¤æ‰§è¡Œã€‚ è¿™ä¸ªå°±æ˜¯ä¸Šé”(LOCK)æ„æ€ã€‚è¿™ä¸€æ®µå’Œä¸Šä¸€æ®µè¿˜æ˜¯æœ‰åŒºåˆ«çš„ï¼Œ è¿™ä¸€æ®µå¼ºè°ƒçš„æ˜¯<strong>å¼€å§‹æ‰§è¡Œä¹‹å‰ç¡®è®¤</strong>ã€‚</p>

<p>å½“ç„¶ç¡®è®¤å¦‚æœä»»åŠ¡æ˜¯å¹‚ç­‰çš„ï¼Œä½ å¯ä»¥è®¾ç½®<code>acks_late</code>é€‰é¡¹æ¥æ§åˆ¶worker åœ¨å‡½æ•°è¿”å›ä¹‹åå»ç¡®è®¤æ¶ˆæ¯<code>acknowledge</code>. è¯·å‚è€ƒ: <a href="http://docs.celeryproject.org/en/latest/faq.html#faq-acks-late-vs-retry%20%22%22">Should I use retry or acks_late?</a></p>

<p>åœ¨è¿™ä¸€ç« èŠ‚ï¼Œ ä½ å°†å­¦ä¹ æ‰€æœ‰å…³äºä»»åŠ¡çš„å®šä¹‰ï¼Œä»¥ä¸‹ä¸ºç›®å½•:</p>
<blockquote class="blockquote-normal">
                <ul><br/><li><a href="#basics">Basics</a></li><br/><li><a href="#names">Names</a></li><br/><li><a href="#context">Context</a></li><br/><li><a href="#logging">Logging</a></li><br/><li><a href="#retrying">Retrying</a></li><br/><li><a href="#listofoptions">List of Options</a></li><br/><li><a href="#states">States</a></li><br/><li><a href="#semipredicates">Semipredicates</a></li><br/><li><a href="#customtaskclasses">Custom task classes</a></li><br/><li><a href="#howitworks">How it works</a></li><br/><li><a href="#tips">Tips and Best Practices</a></li><br/><li><a href="#performance">Performance and Strategies</a></li><br/><li><a href="#example">Example</a></li><br/></ul></blockquote>
<h2>Basics <span id="basics"></span></h2>

<p>ä½ å¯ä»¥å¾ˆå®¹æ˜“çš„åˆ›å»ºä»»åŠ¡åœ¨ä»»ä½•çš„å¯è°ƒç”¨å‡½æ•°ä¸Šä½¿ç”¨<code>task()</code>è£…é¥°å™¨.</p>
<div class="code-wrapper"><a href="#code-6236458532942578516" id="code-6236458532942578516" class="lang-label">Python</a><div class="title-label empty">&nbsp;</div><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">User</span>

<span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">create_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
</pre></div>
</div>
<p>å¯ä»¥åœ¨è£…é¥°å™¨ä¸ŠæŒ‡å®šå‚æ•°ï¼Œ æ¥è®¾ç½®<code>Task</code></p>
<div class="code-wrapper"><a href="#code-922181300334507367" id="code-922181300334507367" class="lang-label">Python</a><div class="title-label empty">&nbsp;</div><div class="highlight"><pre><span></span><span class="nd">@app.task</span><span class="p">(</span><span class="n">serializer</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">create_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Multiple decorators</strong></p>

<p>å½“ä½¿ç”¨å¤šä¸ªè£…é¥°å™¨ï¼Œéœ€è¦ç¡®ä¿ä»»åŠ¡è£…é¥°ç”Ÿæ•ˆï¼Œ æŠŠ<code>task decorator</code> å†™åœ¨å‡½æ•°ç¬¬ä¸€ä¸ªè£…é¥°å™¨.</p>
<div class="code-wrapper"><a href="#code-1679104579001327761" id="code-1679104579001327761" class="lang-label">Python</a><div class="title-label empty">&nbsp;</div><div class="highlight"><pre><span></span><span class="nd">@app.task</span>
<span class="nd">@decorator2</span>
<span class="nd">@decorator1</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
<p><strong>å¦‚ä½•å¼•å…¥taskè£…é¥°å™¨ï¼Ÿ</strong></p>

<p><code>task decorator</code> å­˜åœ¨äºä½ çš„Celeryåº”ç”¨çš„å®ä¾‹ä¸Šï¼Œ ä¸Šä¸€èŠ‚æˆ‘ä»¬å·²ç»è®²è¿‡å¦‚ä½•å£°æ˜Applicationå’Œä½¿ç”¨å®ƒ. </p>

<p>å¦‚æœä½ ä½¿ç”¨çš„æ˜¯Django æˆ–è€…ä»ç„¶é€‚ç”¨è€çš„ç‰ˆæœ¬ï¼Œ ä½ å¯èƒ½å¯¼å…¥<code>task decorator</code>çš„æ–¹å¼æ˜¯ä¸‹é¢è¿™æ ·.</p>
<div class="code-wrapper"><a href="#code8906058190960697092" id="code8906058190960697092" class="lang-label">Python</a><div class="title-label empty">&nbsp;</div><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">task</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
<h2>Names <span id="names"></span></h2>

<p>æ¯ä¸ªä»»åŠ¡éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„åç§°ï¼Œ ä¸€ä¸ªä»»åŠ¡åˆ›å»ºæ—¶å¦‚æœä¸æä¾›ä¸€ä¸ªè‡ªå®šä¹‰çš„åå­—ï¼Œ å°†ä¼šå»ç”Ÿæˆä¸€ä¸ªä»»åŠ¡.</p>
<div class="code-wrapper"><a href="#code-2299577409727620311" id="code-2299577409727620311" class="lang-label">Python</a><div class="title-label empty">&nbsp;</div><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="nd">@app.task</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;sum-of-two-numbers&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">add</span><span class="o">.</span><span class="n">name</span>
<span class="s1">&#39;sum-of-two-numbers&#39;</span>
</pre></div>
</div>
<p>æœ€å¥½çš„æ–¹å¼æ˜¯é€‚ç”¨æ¨¡å—åç§°ä½œä¸ºä¸€ä¸ªåç§°ç©ºé—´ï¼Œå¦‚æœä¸€ä¸ªä»»åŠ¡å¦å¤–ä¸€ä¸ªæ¨¡å—ä¸­ä¹Ÿæœ‰è¿™æ ·çš„åç§°å¦‚useræ¨¡å—ä¸­æœ‰<code>add</code>, group æ¨¡å—ä¸­ä¹Ÿæœ‰<code>add</code>, é‚£ä¹ˆè¿™æ ·å°±ä¼šå†²çª. æœ€å¥½çš„æ–¹å¼å¦‚ä¸‹:</p>
<div class="code-wrapper"><a href="#code-3286940235279928968" id="code-3286940235279928968" class="lang-label">Python</a><div class="title-label empty">&nbsp;</div><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="nd">@app.task</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;tasks.add&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
<p>ä½ å¯ä»¥é€šè¿‡è°ƒç”¨taskçš„å±æ€§æ¥è·å–task name.</p>
<div class="code-wrapper"><a href="#code2673943182271487474" id="code2673943182271487474" class="lang-label">Python</a><div class="title-label empty">&nbsp;</div><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">add</span><span class="o">.</span><span class="n">name</span>
<span class="s1">&#39;tasks.add&#39;</span>
</pre></div>
</div>
<p>å¦‚æœä¸æŒ‡å®šï¼Œ é»˜è®¤ä¹Ÿä¼šé€šè¿‡æ¨¡å—åå’Œå‡½æ•°åæ‹¼è£…ç”Ÿæˆname</p>

<p><code>tasks.py</code>:</p>
<div class="code-wrapper"><a href="#code9027954037110941027" id="code9027954037110941027" class="lang-label">Python</a><div class="title-label empty">&nbsp;</div><div class="highlight"><pre><span></span><span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">tasks</span> <span class="kn">import</span> <span class="n">add</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">add</span><span class="o">.</span><span class="n">name</span>
<span class="s1">&#39;tasks.add&#39;</span>
</pre></div>
</div>
<p><strong>è‡ªåŠ¨å‘½åå’Œç›¸å¯¹import</strong></p>

<p>ç›¸å¯¹importå’Œè‡ªåŠ¨å‘½åä¸èƒ½ä¸€èµ·å·¥ä½œï¼Œ æ‰€ä»¥å¦‚æœé€‚ç”¨ç›¸å¯¹å¼•å…¥ä½ å¿…é¡»ç²¾ç¡®çš„è®¾ç½®name.</p>

<p>å¦‚æœä¸€ä¸ªå®¢æˆ·ç«¯(åˆ›å»ºæ¶ˆæ¯çš„æ—¶å€™) å¯¼å…¥è¿™ä¸ª<code>myapp.tasks</code> é€šè¿‡<code>.tasks</code>å¯¼å…¥ï¼Œå¦å¤–ä¸€ä¸ªworkerå¯¼å…¥æ¨¡å—é€šè¿‡<code>myapp.tasks</code>ï¼Œ ç”Ÿæˆçš„åç§°ä¸åŒ¹é…å¯¼è‡´workerä¼šæŠ›å‡º<code>NotRegistered</code> ä»è€Œä¸èƒ½å·¥ä½œ.</p>

<p>Django INSTALLED_APPSçš„<code>project.myapp</code>é£æ ¼.</p>
<div class="code-wrapper"><a href="#code-6217958142329055367" id="code-6217958142329055367" class="lang-label">Python</a><div class="title-label empty">&nbsp;</div><div class="highlight"><pre><span></span><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;project.myapp&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>å¦‚æœä½ å®‰è£…appä½¿ç”¨<code>project.myapp</code>, é‚£ä¹ˆtaskå¯¼å…¥çš„æ—¶å€™ä¹Ÿè¦é€šè¿‡<code>project.myapp.tasks</code>å¯¼å…¥ï¼Œ æ‰€ä»¥ä½ è¦ç¡®ä¿æ€»æ˜¯ä½¿ç”¨ç›¸åŒçš„åç§°å¯¼å…¥ä»»åŠ¡.</p>
<div class="code-wrapper"><a href="#code-8122460902249026004" id="code-8122460902249026004" class="lang-label">Python</a><div class="title-label empty">&nbsp;</div><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">project.myapp.tasks</span> <span class="kn">import</span> <span class="n">mytask</span>   <span class="c1"># &lt;&lt; GOOD</span>

<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">myapp.tasks</span> <span class="kn">import</span> <span class="n">mytask</span>    <span class="c1"># &lt;&lt; BAD!!!</span>
</pre></div>
</div>
<p>ä¸Šé¢ç¬¬äºŒä¸ªä¾‹å­å°†å¯¼è‡´ä»»åŠ¡ä»¥ä¸åŒçš„æ–¹å¼å‘½åï¼Œ è¿›è€Œå¯¼è‡´å®¢æˆ·ç«¯å’Œworkerä¸ç”¨çš„ä»»åŠ¡åç§°ã€‚</p>
<div class="code-wrapper"><a href="#code-760857020160131381" id="code-760857020160131381" class="lang-label">Python</a><div class="title-label empty">&nbsp;</div><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">project.myapp.tasks</span> <span class="kn">import</span> <span class="n">mytask</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mytask</span><span class="o">.</span><span class="n">name</span>
<span class="s1">&#39;project.myapp.tasks.mytask&#39;</span>

<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">myapp.tasks</span> <span class="kn">import</span> <span class="n">mytask</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">mytask</span><span class="o">.</span><span class="n">name</span>
<span class="s1">&#39;myapp.tasks.mytask&#39;</span>
</pre></div>
</div>
<p>å› è€Œä½ å¯¼å…¥å¿…é¡»ä¸€è‡´ï¼Œ è¿™ä¹Ÿæ˜¯pythonæ¨èçš„æ–¹å¼ã€‚</p>

<p>åŒæ ·çš„ä½ ä¸åº”è¯¥ä½¿ç”¨æ—§é£æ ¼è¿›è¡Œç›¸å¯¹å¼•å…¥.</p>
<div class="code-wrapper"><a href="#code3666126293282668563" id="code3666126293282668563" class="lang-label">Python</a><div class="title-label empty">&nbsp;</div><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">module</span> <span class="kn">import</span> <span class="n">foo</span>   <span class="c1"># BAD!</span>

<span class="kn">from</span> <span class="nn">proj.module</span> <span class="kn">import</span> <span class="n">foo</span>  <span class="c1"># GOOD!</span>
</pre></div>
</div>
<p>ä»¥ä¸‹æ–°çš„é£æ ¼ç›¸å¯¹å¼•å…¥ä¹Ÿæ˜¯å¯ä»¥æ¨èçš„</p>
<div class="code-wrapper"><a href="#code-3037779520922229629" id="code-3037779520922229629" class="lang-label">Python</a><div class="title-label empty">&nbsp;</div><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">.module</span> <span class="kn">import</span> <span class="n">foo</span>  <span class="c1"># GOOD!</span>
</pre></div>
</div>
<p>å¦‚æœä½ çš„ç¨‹åºå·²ç»åšäº†é”™çš„å¼•å…¥ï¼Œ å¹¶ä¸”ä½ æ²¡æœ‰æ—¶é—´å»é‡æ„ï¼Œ å»ºè®®é€šè¿‡æ˜¾å¼çš„æŒ‡å®šåç§°å»è¦†ç›–è‡ªåŠ¨å‘½å.</p>
<div class="code-wrapper"><a href="#code8820778316050957677" id="code8820778316050957677" class="lang-label">Python</a><div class="title-label empty">&nbsp;</div><div class="highlight"><pre><span></span><span class="nd">@task</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;proj.tasks.add&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
<h2>Context <span id="context"></span></h2>

<p>æ‰§è¡Œä»»åŠ¡<code>request</code> åŒ…å«çš„ä¿¡æ¯å’ŒçŠ¶æ€.</p>

<p><code>request</code>å®šä¹‰äº†ä»¥ä¸‹å±æ€§</p>
<div class="code table-wrapper"><table class="ui selectable celled table"><thead>
<tr>
<th>key</th>
<th>value</th>
</tr>
</thead>

<tbody>
<tr>
<td><strong>id:</strong></td>
<td>æ‰§è¡Œä»»åŠ¡çš„å”¯ä¸€ID</td>
</tr>
<tr>
<td><strong>group:</strong></td>
<td>ç»„idå¦‚æœå±äºç»„</td>
</tr>
<tr>
<td><strong>chord:</strong></td>
<td>The unique id of the chord this task belongs to (if the task is part of the header).</td>
</tr>
<tr>
<td><strong>args:</strong></td>
<td>ä½ç½®å‚æ•°</td>
</tr>
<tr>
<td><strong>kwargs:</strong></td>
<td>é”®å€¼å‚æ•°</td>
</tr>
<tr>
<td><strong>retries:</strong></td>
<td>é‡æ‹¾æ¬¡æ•°</td>
</tr>
<tr>
<td><strong>is_eager:</strong></td>
<td>å¦‚æœä¸æ˜¯å·¥äººæ˜¯æœ¬åœ°å®¢æˆ·ç«¯ï¼Œè®¾ç½®ä¸ºTrue</td>
</tr>
<tr>
<td><strong>eta:</strong></td>
<td>é¢„è®¡ä»»åŠ¡æ—¶é—´</td>
</tr>
<tr>
<td><strong>expires:</strong></td>
<td>ä»»åŠ¡çš„è¿‡æœŸæ—¶</td>
</tr>
<tr>
<td><strong>logfile:</strong></td>
<td>worker çš„æ—¥å¿—æ–‡ä»¶, See: <a href="#logging">logging</a></td>
</tr>
<tr>
<td><strong>loglevel:</strong></td>
<td>å½“å‰ä½¿ç”¨çš„æ—¥å¿—çº§åˆ«</td>
</tr>
<tr>
<td><strong>hostname:</strong></td>
<td>workerå®ä¾‹çš„hostname</td>
</tr>
<tr>
<td><strong>delivery_info:</strong></td>
<td>é¢å¤–çš„ä¼ é€’ä¿¡æ¯</td>
</tr>
<tr>
<td><strong>called_directly:</strong></td>
<td>This flag is set to true if the task was not executed by the worker.</td>
</tr>
<tr>
<td><strong>callbacks:</strong></td>
<td>å›è°ƒå‡½æ•°</td>
</tr>
<tr>
<td><strong>errback:</strong></td>
<td>å¼‚å¸¸å›è°ƒå‡½æ•°</td>
</tr>
<tr>
<td><strong>utc:</strong></td>
<td>å¦‚æœä¸ºTrueè¯´æ˜è°ƒç”¨è€…å¯åŠ¨äº†utc</td>
</tr>
</tbody>
</table></div>
<p>3.1 æ–°å±æ€§
key|value
---|---
<strong>headers:</strong>|æ˜ å°„æ¶ˆæ¯å¤´
<strong>reply_to:</strong>|å‘é€replayåˆ°å“ªä¸ªé˜Ÿåˆ—
<strong>correlation_id:</strong>|é€šå¸¸ä¸ä»»åŠ¡idé€šç”¨ï¼Œ å¸¸ç”¨è¯­amqpçš„è·Ÿè¸ªå›å¤</p>

<p>ä¸€ä¸ªä»contextè·å–è·å–ä¿¡æ¯çš„ä¾‹å­:</p>
<div class="code-wrapper"><a href="#code6469855219393974862" id="code6469855219393974862" class="lang-label">Python</a><div class="title-label empty">&nbsp;</div><div class="highlight"><pre><span></span><span class="nd">@app.task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">dump_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Executing task id {0.id}, args: {0.args!r} kwargs: {0.kwargs!r}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">))</span>
</pre></div>
</div>
<h2>Logging <span id="logging"></span></h2>

<p>worker å°†ä¼šè‡ªåŠ¨é…ç½®loggingï¼Œ ä¹Ÿå¯ä»¥æ‰‹åŠ¨é…ç½®å®šåˆ¶logging æ—¥å¿—è¾“å‡º.</p>

<p>Celery æä¾›ä¸€ä¸ªåä¸º<code>celery.task</code>çš„loggerä¾›ä½¿ç”¨, ä½ å¯ä»¥é€šè¿‡è¿™ä¸ªlogger è‡ªåŠ¨çš„ç”Ÿæˆä¸€ä¸ªåç§°å’Œå”¯ä¸€idä½œä¸ºæ—¥å¿—çš„ä¸€éƒ¨åˆ†.</p>

<p>æ¨èåœ¨æ¯ä¸ªæ¨¡å—ä¸­éƒ½å£°æ˜ä¸€ä¸ªloggerï¼Œ æ¯ä¸ªæ¨¡å—ä½¿ç”¨å•ç‹¬çš„logger.</p>
<div class="code-wrapper"><a href="#code-348028001822756677" id="code-348028001822756677" class="lang-label">Python</a><div class="title-label empty">&nbsp;</div><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">celery.utils.log</span> <span class="kn">import</span> <span class="n">get_task_logger</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">get_task_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Adding {0} + {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
<p>Celery ä½¿ç”¨Pythonæ ‡å‡†åº“çš„loggingæ¨¡å—ï¼Œ æ–‡æ¡£æ”¯æŒå¯ä»¥åœ¨<a href="http://docs.python.org/dev/library/logging.html#module-logging">logging</a> æ¨¡å—ä¸­çœ‹åˆ°</p>

<p>ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨<code>print()</code>, ä»»ä½•å†™å…¥æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯éƒ½ä¼šè½¬åˆ°æ—¥å¿—ç³»ç»Ÿã€‚ æ‰€ä»¥printçš„å­—ç¬¦ä¹Ÿä¼šä½œä¸ºæ—¥å¿—è®°å½•ï¼Œ è®°å½•ç­‰çº§ä¸º<strong>WARN</strong>.</p>

<h2>Retrying <span id="retrying"></span></h2>

<p><code>retry()</code> å¯ä»¥é‡è¯•ä»»åŠ¡ï¼Œ å½“ä»»åŠ¡å‡ºç°å¯æ¢å¤çš„é”™è¯¯.</p>

<p>å½“è°ƒç”¨<code>retry()</code>æ—¶å°†ä¼šå‘é€ä¸€ä¸ªæ–°çš„æ¶ˆæ¯ï¼Œ ä½¿ç”¨ç›¸åŒçš„task-id,  ç¡®ä¿æ¶ˆæ¯å’ŒåŸå§‹ä»»åŠ¡å±äºç›¸åŒçš„é˜Ÿåˆ—.</p>

<p>å½“ä¸€ä¸ªæ¶ˆæ¯é‡è¯•åï¼Œ ä»»åŠ¡ä¹Ÿä¼šè®°å½•ä¸€ä¸ªçŠ¶æ€ã€‚è¿™æ ·ä½ å¯ä»¥ä½¿ç”¨ç»“æœå®ä¾‹è·Ÿè¸ªä»»åŠ¡çŠ¶æ€è®°å½•(see <a href="#states">States</a>)</p>

<p>ä¸€ä¸ªä½¿ç”¨<code>retry()</code> çš„ä¾‹å­:</p>
<div class="code-wrapper"><a href="#code8724654498202957670" id="code8724654498202957670" class="lang-label">Python</a><div class="title-label empty">&nbsp;</div><div class="highlight"><pre><span></span><span class="nd">@app.task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">send_twitter_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oauth</span><span class="p">,</span> <span class="n">tweet</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">twitter</span> <span class="o">=</span> <span class="n">Twitter</span><span class="p">(</span><span class="n">oauth</span><span class="p">)</span>
        <span class="n">twitter</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">Twitter</span><span class="o">.</span><span class="n">FailWhaleError</span><span class="p">,</span> <span class="n">Twitter</span><span class="o">.</span><span class="n">LoginError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="n">exc</span><span class="p">)</span>
</pre></div>
</div>
<p><code>bind</code> å‚æ•°å‘Šè¯‰è£…é¥°å™¨å°†ä¼šç»™ä¸€ä¸ªå¯ä»¥è®¿é—®çš„selfå®ä¾‹.</p>

<p>å½“å­˜å‚¨ä»»åŠ¡ç»“æœï¼Œexc æ˜¯ç”¨äºä¼ é€’å¼‚å¸¸ä¿¡æ¯ç”¨æˆ·æ—¥å¿—è¾“å‡ºã€‚ å†…å®¹æœ‰å¼‚å¸¸ä¿¡æ¯å’Œtracebackä¿¡æ¯éƒ½å­˜åœ¨äºexc.</p>

<p>å¦‚æœæ­¤ä»»åŠ¡æœ‰<code>max_retries</code>å€¼ï¼Œ å¹¶ä¸”é‡è¯•æ¬¡æ•°è¶…è¿‡äº†è¿™ä¸ªå€¼ï¼Œ é‚£ä¹ˆè¿™ä¸ªexcå¼‚å¸¸å°†ä¼šé‡æ–°raise.  å¦‚æœæ˜¯ä¸‹åˆ—æƒ…å†µå°†ä¸ä¼šè¿™æ ·:</p>

<ul>
<li>exc æ²¡æœ‰æŒ‡å®š</li>
</ul>

<p>è¿™ç§æƒ…å†µä¸‹å°†ä¼šraise <code>MaxRetriesExceeded</code>å¼‚å¸¸, è¿™ä¸ªæ˜¯é»˜è®¤å¼‚å¸¸</p>

<ul>
<li>æ²¡æœ‰å¼‚å¸¸</li>
</ul>

<p>å½“é‡è¯•æ²¡æœ‰å¼‚å¸¸å‘ç”Ÿ(ä¹Ÿå°±æ˜¯ä¸Šé¢exceptæ²¡æœ‰å‘ç”Ÿ)ï¼Œ é‡è¯•æ¬¡æ•°è¾¾åˆ°äº†ï¼Œ ä½†taskè¿˜æ²¡æœ‰æ­£ç¡®è¿”å›ï¼Œ å¯ä»¥æŒ‡å®šç»™excä¸€ä¸ªå¼‚å¸¸ï¼Œ ç”¨äºä»£ç†é»˜è®¤çš„<code>MaxRetriesExceeded</code>.</p>
<div class="code-wrapper"><a href="#code7965189948101792626" id="code7965189948101792626" class="lang-label">Python</a><div class="title-label empty">&nbsp;</div><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="n">Twitter</span><span class="o">.</span><span class="n">LoginError</span><span class="p">())</span>
</pre></div>
</div>
<p>å°†ä¼šè§¦å‘æä¾›çš„å¼‚å¸¸ä¿¡æ¯ã€‚ </p>

<p><strong>è‡ªå®šä¹‰é‡è¯•é—´éš”</strong></p>

<p>å½“ä¸€ä¸ªä»»åŠ¡è¦å»é‡è¯•ï¼Œ å¯ä»¥æŒ‡å®šä¸€ä¸ªæ—¶é—´ä¹‹åå†å»é‡è¯•. ä½¿ç”¨<code>default_retry_delay</code>å±æ€§æ¥è®¾ç½®é»˜è®¤å»¶è¿Ÿ.é»˜è®¤æ˜¯ä¸‰åˆ†é’Ÿ,  æ³¨æ„: å»¶è¿Ÿçš„å•ä½æ˜¯ç§’.</p>

<p>ä½ å¯ä»¥ä½¿ç”¨ <code>retry(..., countdown=60s)</code>æ¥è¦†ç›–taskçº§åˆ«çš„<code>default_retry_delay</code>æ—¶é—´. ä¸¤ç§æ–¹æ³•çµæ´»ä½¿ç”¨ </p>
<div class="code-wrapper"><a href="#code6098786419085452958" id="code6098786419085452958" class="lang-label">Python</a><div class="title-label empty">&nbsp;</div><div class="highlight"><pre><span></span><span class="nd">@app.task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">default_retry_delay</span><span class="o">=</span><span class="mi">30</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>  <span class="c1"># retry in 30 minutes.</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="err">â€¦</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="n">exc</span><span class="p">,</span> <span class="n">countdown</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>  <span class="c1"># override the default and                                                 # retry in 1 minute</span>
</pre></div>
</div>
<h2>List of Options <span id="listofoptions"></span></h2>

<p>Task.<strong>name</strong></p>

<p>task æ³¨å†Œå</p>

<p>å¯ä»¥æ‰‹åŠ¨è®¾ç½®ï¼Œä¹Ÿå¯ä»¥ç”Ÿæˆæ­¤name. See: <a href="#names">Names</a></p>

<p>æœªå®Œå¾…ç»­&gt;&gt;&gt;</p>

    </div>

    


    <div id="donate" style="text-align: center;">
        <a href="#donation-wrapper"><div onclick="displayDonation()" class="ui basic button">æ‰“èµ <i class="gift icon"></i></div></a>
    </div>
    <div id="comments">
    </div>
    <div id="more-words">
        <a href="/#entrys"><div id="more-words">æ›´å¤šæ—¥å¿—</div></a>
    </div>
</div>

        </div>

        <div id="footer" class="footer">
            <div id="jinrishici-tag">é•¿æ¨</div>
            <span id="jinrishici-sentence">è‡ªæ˜¯äººç”Ÿé•¿æ¨æ°´é•¿ä¸œ.</span>
        </div>

        <div id="end">
            <span>Â©   JackeyGao.io 2018.</span>
            <br/>
            <i style="margin-top: 10px; color: var(--main-bg);" class="superpowers icon"></i>
        </div>

    </body>
    
    
    <script src="/assets/js/web.js"></script>
    <script>
        var wrappers = ["donation-wrapper", "social-links-wrapper", "search-wrapper", "site-wrapper", "friends-links-wrapper"]
        window.onload = function () {
            useWechat();
        }

        var skin = localStorage.getItem('skin');

        if (skin) {
            document.body.className = skin;
        } else {
            localStorage.setItem('skin', 'sk-default');
        }

        // ç»Ÿè®¡ä»£ç 
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-93231524-1', 'auto');
        ga('send', 'pageview');

        // ä»Šæ—¥è¯—è¯
        var xhr = new XMLHttpRequest();
        xhr.open('get', 'https://v2.jinrishici.com/one.json');
        xhr.withCredentials = true;
        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4) {
            var data = JSON.parse(xhr.responseText);
            // å¤„ç†ç¤ºä¾‹
            var gushici = document.getElementById('jinrishici-sentence');
            gushici.innerText = data.data.content;
            var gushiciTag = document.getElementById('jinrishici-tag');
            gushiciTag.innerText = data.data.matchTags[0];
          }
        };
        xhr.send();

    </script>
    
    <script src="/assets/3rd/gitalk.min.js"></script>
    <script>
    const gitalk = new Gitalk({
        clientID: '177af99888a292531873',
        clientSecret: '7c0927c7cdf0d94eed7dad0b238552c10ec6f53c',
        repo: 'JackeyGao.github.io',
        owner: 'jackeyGao',
        admin: ['jackeyGao'],
        id: 'celery-userguide-tasks',      // Ensure uniqueness and length less than 50
        distractionFreeMode: false,  // Facebook-like distraction free mode
        labels: ['gitment'],
        pagerDirection: "last"
    })
      
    gitalk.render('comments')
    </script>


</html>